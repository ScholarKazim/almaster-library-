{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-12 col-md-5">
        <div class="card border-0 shadow-lg rounded-5 overflow-hidden">
            <div class="bg-grad-blue p-5 text-center text-white">
                <h2 class="fw-bold mb-0">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ù…Ø§Ø³ØªØ±</h2>
                <p class="small opacity-75 mt-2">Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙˆØ§Ù„Ø§Ø³Ù…</p>
            </div>

            <div class="card-body p-4 p-md-5 bg-white">
                <div id="step-1">
                    <div class="mb-4">
                        <label class="form-label small fw-bold text-muted">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ (Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ)</label>
                        <input type="text" id="username"
                            class="form-control form-control-lg rounded-pill px-4 shadow-sm border-2"
                            placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§">
                    </div>
                    <div class="mb-4">
                        <label class="form-label small fw-bold text-muted">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                        <input type="tel" id="phone"
                            class="form-control form-control-lg rounded-pill px-4 text-center shadow-sm border-2"
                            dir="ltr" placeholder="07XXXXXXXXX">
                    </div>

                    <div class="d-grid gap-3">
                        <button onclick="handleLogin()" id="btn-login"
                            class="btn btn-grad-blue btn-lg rounded-pill py-3 fw-bold shadow-lg">
                            Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ØªØ¬Ø± ğŸš€
                        </button>
                    </div>
                </div>

                <div id="login-error" class="alert alert-danger mt-4 d-none rounded-4 small"></div>

                <p class="text-center small text-muted mt-4">
                    Ø³ÙŠØªÙ… Ø­ÙØ¸ Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† Ù…ØªØ§Ø¨Ø¹Ø© Ø·Ù„Ø¨Ø§ØªÙƒ Ù„Ø§Ø­Ù‚Ø§Ù‹.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
    function handleLogin() {
        const username = document.getElementById('username').value;
        const phone = document.getElementById('phone').value;
        const btn = document.getElementById('btn-login');
        const errorDiv = document.getElementById('login-error');

        if (!username || !phone) {
            showError("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ");
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...';

        // 1. Log them in directly on the server
        fetch('/api/direct_login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone, username })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    window.location.href = '/';
                } else {
                    showError(data.error || "ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„");
                    btn.disabled = false;
                    btn.innerText = 'Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ØªØ¬Ø± ğŸš€';
                }
            })
            .catch(err => {
                showError("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„");
                btn.disabled = false;
                btn.innerText = 'Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ØªØ¬Ø± ğŸš€';
            });
    }

    function showError(msg) {
        const errorDiv = document.getElementById('login-error');
        errorDiv.innerText = msg;
        errorDiv.classList.remove('d-none');
    }
</script>
{% endblock %}