{% extends "base.html" %}

{% block content %}
<div class="row">
    <!-- Image Gallery Section -->
    <div class="col-12 col-md-6 mb-4">
        <div class="product-gallery bg-white rounded-5 shadow-sm overflow-hidden p-3 border position-relative">
            <!-- Main Featured Image with Arrows -->
            <div class="ratio ratio-1x1 mb-3 rounded-4 overflow-hidden position-relative bg-light">
                <img id="mainImg" src="{{ product.image_url }}" class="object-fit-contain w-100 h-100"
                    alt="{{ product.title }}">

                {% if product.images|length > 1 %}
                <button class="nav-arrow prev-arrow" onclick="navGallery(-1)">â®</button>
                <button class="nav-arrow next-arrow" onclick="navGallery(1)">â¯</button>
                {% endif %}
            </div>

            <!-- Descriptive Pagination Info -->
            {% if product.images|length > 1 %}
            <div class="text-center small text-muted mb-3" id="imgCounter">
                ØµÙˆØ±Ø© 1 Ù…Ù† {{ product.images|length }}
            </div>
            {% endif %}

            <!-- Thumbnails Scrollable -->
            <div class="d-flex gap-2 overflow-auto pb-2 px-1 scroll-hide mb-2 justify-content-center"
                id="thumbContainer">
                {% for img in product.images %}
                <div class="thumb-wrapper rounded-3 overflow-hidden border {% if loop.first %}active{% endif %} flex-shrink-0"
                    style="width: 70px; height: 70px; cursor: pointer;" data-index="{{ loop.index0 }}">
                    <img src="{{ img.image_url }}" class="w-100 h-100 object-fit-cover"
                        onclick="changeImg('{{ img.image_url }}', {{ loop.index0 }})">
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Product Details Section -->
    <div class="col-12 col-md-6">
        <div class="ps-md-4">
            <nav aria-label="breadcrumb" class="mb-3">
                <ol class="breadcrumb small">
                    <li class="breadcrumb-item"><a href="{{ url_for('index') }}"
                            class="text-decoration-none">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></li>
                    <li class="breadcrumb-item active">{{ product.category }}</li>
                </ol>
            </nav>

            <h1 class="display-6 fw-bold mb-2 text-dark">{{ product.title }}</h1>
            <div class="mb-4">
                <span class="fs-2 fw-bold text-primary">{{ "{:,.0f}".format(product.price) }} Ø¯.Ø¹</span>
                <span class="badge bg-success-light text-success ms-2 rounded-pill">Ù…ØªÙˆÙØ± Ø§Ù„Ø¢Ù†</span>
            </div>

            <p class="text-secondary lh-lg mb-4">{{ product.description or 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ Ù…ØªØ§Ø­ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ø­Ø§Ù„ÙŠØ§Ù‹.' }}</p>

            <!-- Customization Section -->
            <div class="bg-light p-4 rounded-4 mb-5 shadow-inner border border-dashed">
                <h6 class="fw-bold mb-4 text-dark"><span class="me-2">âœï¸</span>Ù…ÙˆØ§ØµÙØ§Øª Ø§Ù„Ø·Ù„Ø¨</h6>

                <div class="mb-0">
                    <label class="form-label small fw-bold mb-2 text-primary">Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¯ÙŠØ²Ø§ÙŠÙ† ÙˆØ§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø®ØªØ§Ø±</label>
                    <textarea id="customNote" class="form-control form-control-grad bg-white border-0 shadow-sm"
                        rows="3" placeholder="Ù…Ø«Ø§Ù„: Ø¯ÙŠØ²Ø§ÙŠÙ† Ø±Ù‚Ù… 3 - Ø§Ø³Ù… Ø­ÙŠØ¯Ø±"></textarea>
                </div>
            </div>

            <div class="d-grid gap-3 mb-5">
                <button onclick="addToCart({{ product.id }}, this)"
                    class="btn btn-grad-blue btn-lg py-3 rounded-pill fw-bold shadow-lg">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø­Ù‚ÙŠØ¨Ø© ğŸ›’</button>
            </div>
        </div>
    </div>
</div>

<style>
    .scroll-hide::-webkit-scrollbar {
        display: none;
    }

    .scroll-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    .nav-arrow {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255, 255, 255, 0.9);
        border: none;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        font-size: 20px;
        color: var(--primary-color);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        z-index: 10;
        transition: all 0.2s ease;
    }

    .nav-arrow:hover {
        background: white;
        transform: translateY(-50%) scale(1.1);
        color: #000;
    }

    .prev-arrow {
        left: 15px;
    }

    .next-arrow {
        right: 15px;
    }

    .thumb-wrapper {
        transition: all 0.2s;
        border: 2px solid #eee !important;
        opacity: 0.7;
    }

    .thumb-wrapper.active {
        border-color: var(--primary-color) !important;
        border-width: 3px !important;
        opacity: 1;
        transform: scale(1.05);
    }

    .shadow-inner {
        box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);
    }

    .product-gallery {
        position: sticky;
        top: 100px;
    }

    .bg-success-light {
        background-color: rgba(25, 135, 84, 0.1);
    }
</style>

<script>
    let currentIndex = 0;
    const images = [{% for img in product.images %}"{{ img.image_url }}", {% endfor %}];

    function changeImg(src, index) {
        currentIndex = index;
        document.getElementById('mainImg').src = src;

        // Update Counter
        const counter = document.getElementById('imgCounter');
        if (counter) counter.innerText = `ØµÙˆØ±Ø© ${index + 1} Ù…Ù† ${images.length}`;

        // Update Thumbnails
        document.querySelectorAll('.thumb-wrapper').forEach((w, i) => {
            if (i === index) w.classList.add('active');
            else w.classList.remove('active');
        });

        // Scroll thumb into view
        const activeThumb = document.querySelector(`.thumb-wrapper[data-index="${index}"]`);
        if (activeThumb) {
            activeThumb.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }
    }

    function navGallery(dir) {
        if (images.length <= 1) return;
        currentIndex = (currentIndex + dir + images.length) % images.length;
        changeImg(images[currentIndex], currentIndex);
    }

    function addToCart(productId, btn) {
        const note = document.getElementById('customNote').value;
        if (!note) {
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¯ÙŠØ²Ø§ÙŠÙ† ÙˆØ§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨');
            return;
        }

        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        cart.push({ id: productId, note: note });
        localStorage.setItem('cart', JSON.stringify(cart));

        if (typeof updateCartBadge === 'function') updateCartBadge();

        btn.innerText = 'ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ“';
        btn.classList.replace('btn-grad-blue', 'btn-success');

        setTimeout(() => {
            btn.innerText = 'Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø­Ù‚ÙŠØ¨Ø© ğŸ›’';
            btn.classList.replace('btn-success', 'btn-grad-blue');
        }, 2000);
    }
</script>
{% endblock %}