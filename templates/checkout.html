{% extends "base.html" %}

{% block content %}
<div class="mb-5 text-center">
    <h1 class="display-5 fw-bold mb-2">ุชุฃููุฏ ุทูุจ ุงูุชุฎุฑุฌ</h1>
    <p class="text-secondary">ุณูุชู ุงูุชูุงุตู ูุนู ูุงุชููุงู ูุชุฃููุฏ ุงูุชูุงุตูู ูุงูุชูุตูู</p>
</div>

<div class="row">
    <div class="col-12 col-md-5 order-md-2 mb-5">
        <div class="p-4 rounded-5 bg-white shadow-lg border-top border-4 border-primary">
            <h5 class="fw-bold mb-4 text-primary">ููุฎุต ุงูุชุฌููุฒุงุช</h5>
            <div id="checkout-items" class="mb-4">
                <div class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                    <span class="ms-2 small">ุฌุงุฑู ุชุญููู ุงูููุฎุต...</span>
                </div>
            </div>
            <hr>
            <div class="d-flex justify-content-between fs-3 fw-bold text-dark mb-2">
                <span>ุงูุฅุฌูุงูู</span>
                <span id="checkout-total">0 ุฏ.ุน</span>
            </div>
            <p class="small text-success mb-0 d-flex align-items-center">
                <span class="me-2">๐ฆ</span> ุชูุตูู ุขูู ูุจุงุจ ุงูุจูุช ุฎูุงู 24-48 ุณุงุนุฉ
            </p>
        </div>
    </div>

    <div class="col-12 col-md-7 order-md-1">
        <form action="{{ url_for('checkout') }}" method="POST" id="checkoutForm">
            <input type="hidden" name="cart_data" id="cartDataInput">

            <div class="small fw-bold text-primary opacity-75 mb-3">ุจูุงูุงุช ุงููุณุชูู (ุจุงูุนุฑุจู)</div>
            <div class="mb-4">
                <input type="text" name="full_name" class="form-control-grad w-100" placeholder="ุงูุงุณู ุงููุงูู ููุทุงูุจ"
                    required pattern="^[\u0600-\u06FF\s]+$" title="ูุฑุฌู ุฅุฏุฎุงู ุงูุงุณู ุจุงููุบุฉ ุงูุนุฑุจูุฉ"
                    value="{{ current_user.username }}">
            </div>

            <div class="mb-4">
                <select name="province" class="form-select form-control-grad w-100" required>
                    <option value="" disabled selected>ุงุฎุชุฑ ุงููุญุงูุธุฉ</option>
                    <option value="ุจุบุฏุงุฏ">ุจุบุฏุงุฏ</option>
                    <option value="ูุฑุจูุงุก ุงูููุฏุณุฉ">ูุฑุจูุงุก ุงูููุฏุณุฉ</option>
                    <option value="ุงููุฌู ุงูุฃุดุฑู">ุงููุฌู ุงูุฃุดุฑู</option>
                    <option value="ุงูุจุตุฑุฉ">ุงูุจุตุฑุฉ</option>
                    <option value="ุจุงุจู">ุจุงุจู</option>
                    <option value="ููููู">ููููู</option>
                    <option value="ุฐู ูุงุฑ">ุฐู ูุงุฑ</option>
                    <option value="ุงูุฃูุจุงุฑ">ุงูุฃูุจุงุฑ</option>
                    <option value="ุฏูุงูู">ุฏูุงูู</option>
                    <option value="ุงููุซูู">ุงููุซูู</option>
                    <option value="ูุฑููู">ูุฑููู</option>
                    <option value="ููุณุงู">ููุณุงู</option>
                    <option value="ูุงุณุท">ูุงุณุท</option>
                    <option value="ุตูุงุญ ุงูุฏูู">ุตูุงุญ ุงูุฏูู</option>
                    <option value="ุฃุฑุจูู">ุฃุฑุจูู</option>
                    <option value="ุฏููู">ุฏููู</option>
                    <option value="ุงูุณูููุงููุฉ">ุงูุณูููุงููุฉ</option>
                </select>
            </div>

            <div class="mb-4">
                <input type="text" name="address" class="form-control-grad w-100"
                    placeholder="ุงูุนููุงู ุฃู ุฃูุฑุจ ููุทุฉ ุฏุงูุฉ" required pattern="^[\u0600-\u06FF\s0-9ุ-]+$"
                    title="ูุฑุฌู ุฅุฏุฎุงู ุงูุนููุงู ุจุงูุนุฑุจู">
            </div>

            <div class="mb-4">
                <input type="tel" name="phone" id="phoneInput" class="form-control-grad w-100"
                    placeholder="ุฑูู ุงููุงุชู (ูุซุงู: 0770xxxxxxx)" required pattern="07[0-9]{9}" maxlength="11"
                    value="{{ current_user.phone }}">
                <div class="form-text mt-2 small text-muted">ูุฌุจ ุฃู ูุจุฏุฃ ุจู 07 ููุชููู ูู 11 ุฑููุงู</div>
            </div>

            <div class="small fw-bold text-primary opacity-75 mb-3 mt-5">ุฎูุงุฑุงุช ุงูุฏูุน</div>
            <div
                class="p-4 rounded-4 bg-white shadow-sm mb-5 d-flex align-items-center justify-content-between border-start border-5 border-success">
                <div class="d-flex align-items-center">
                    <span class="fs-2 me-3">๐ค</span>
                    <div>
                        <span class="fw-bold d-block">ุงูุฏูุน ุนูุฏ ุงูุงุณุชูุงู</span>
                        <span class="small text-secondary">ุงุฏูุน ููุฏุงู ุนูุฏ ุงุณุชูุงู ุทูุจู</span>
                    </div>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="payment" checked>
                </div>
            </div>

            <div class="d-grid mb-5">
                <button type="submit" class="btn btn-grad-blue btn-lg py-3 rounded-pill fw-bold shadow-lg">ุชุฃููุฏ ุทูุจ
                    ุงูุชุฎุฑุฌ ๐ฆ</button>
            </div>
        </form>
    </div>
</div>

<script>
    let globalProducts = [];

    document.addEventListener('DOMContentLoaded', async function () {
        const cart = JSON.parse(localStorage.getItem('cart') || '[]');
        if (cart.length === 0) {
            window.location.href = "{{ url_for('view_cart') }}";
            return;
        }

        document.getElementById('cartDataInput').value = JSON.stringify(cart);

        try {
            const response = await fetch('/api/get_cart_details', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cart: cart })
            });
            globalProducts = await response.json();
            renderSummary(globalProducts);
        } catch (error) {
            console.error('Error fetching summary:', error);
        }
    });

    function renderSummary(items) {
        const container = document.getElementById('checkout-items');
        let html = '';
        let subtotal = 0;

        items.forEach(item => {
            subtotal += item.price;
            html += `
                <div class="d-flex justify-content-between mb-2 small">
                    <span class="text-secondary">${item.title}</span>
                    <span class="fw-bold">${item.price.toLocaleString()} ุฏ.ุน</span>
                </div>
            `;
        });

        html += `
            <div class="d-flex justify-content-between mb-2 small border-top pt-2">
                <span class="text-secondary">ุฑุณูู ุงูุชูุตูู</span>
                <span class="fw-bold">5,000 ุฏ.ุน</span>
            </div>
        `;

        container.innerHTML = html;
        document.getElementById('checkout-total').innerText = (subtotal + 5000).toLocaleString() + " ุฏ.ุน";
    }

    document.getElementById('checkoutForm').addEventListener('submit', function (e) {
        // We let the form submit normally to the server to save the order.
        // The WhatsApp message can be sent manually from the profile or we can 
        // trigger it after success if needed.

        const btn = this.querySelector('button[type="submit"]');
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> ุฌุงุฑู ุญูุธ ุทูุจู...';

        // After save, the server redirects to profile. 
        // The cart will be cleared on the next page load.
        localStorage.removeItem('cart');
    });
</script>
{% endblock %}