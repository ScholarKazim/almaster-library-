{% extends "base.html" %}

{% block content %}
<div class="mb-5 text-center">
    <h1 class="display-5 fw-bold mb-2">ุณูุฉ ุงูุชุฎุฑุฌ</h1>
    <p class="text-secondary">ุชุฃูุฏ ูู ุงุฎุชูุงุฑุงุชู ูููุงุตูุงุช ุงูุชุฎุตูุต</p>
</div>

<div id="cart-container">
    <div class="text-center py-5 opacity-50" id="empty-cart-msg">
        <div class="fs-1 mb-3">๐</div>
        <p>ูู ุชุฎุชุฑ ุฃู ููุชุฌ ุชุฎุฑุฌ ุจุนุฏ.</p>
        <a href="{{ url_for('index') }}" class="btn btn-grad-blue rounded-pill px-5 mt-2">ุงุจุฏุฃ ุงูุชุฌููุฒ ุงูุขู</a>
    </div>
</div>

<div id="cart-loading" class="text-center py-5 d-none">
    <div class="spinner-border text-primary mb-3" role="status"></div>
    <p class="text-secondary">ุฌุงุฑู ุชุญููู ูุญุชููุงุช ุงูุณูุฉ...</p>
</div>

<div id="cart-summary" class="d-none mt-5">
    <div class="p-4 rounded-5 bg-white shadow-lg mb-4 border-top border-4 border-primary">
        <div class="d-flex justify-content-between mb-2">
            <span class="text-muted">ุงููุฌููุน ุงููุฑุนู</span>
            <span id="subtotal" class="fw-bold">0 ุฏ.ุน</span>
        </div>
        <div class="d-flex justify-content-between mb-3">
            <span class="text-muted">ุฑุณูู ุงูุชูุตูู</span>
            <span class="fw-bold text-success">5,000 ุฏ.ุน</span>
        </div>
        <hr>
        <div class="d-flex justify-content-between fs-3 fw-bold text-dark">
            <span>ุงูุฅุฌูุงูู ุงูููู</span>
            <span id="total" class="text-primary">0 ุฏ.ุน</span>
        </div>
    </div>
    <div class="d-grid mb-5">
        <a href="{{ url_for('checkout') }}" class="btn btn-grad-blue btn-lg py-3 rounded-pill fw-bold shadow-lg">ุงุณุชููุงู
            ุจูุงูุงุช ุงูุดุญู</a>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const cartItems = JSON.parse(localStorage.getItem('cart') || '[]');
        if (cartItems.length > 0) {
            document.getElementById('empty-cart-msg').classList.add('d-none');
            document.getElementById('cart-loading').classList.remove('d-none');
            renderCart(cartItems);
        }
    });

    async function renderCart(cartItems) {
        const container = document.getElementById('cart-container');
        const summary = document.getElementById('cart-summary');
        const emptyMsg = document.getElementById('empty-cart-msg');
        const loading = document.getElementById('cart-loading');

        try {
            console.log("Fetching cart details for:", cartItems);
            const response = await fetch('/api/get_cart_details', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cart: cartItems })
            });

            loading.classList.add('d-none');

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || `Server error: ${response.status}`);
            }

            const products = await response.json();
            console.log("Received products:", products);

            if (products.length === 0 && cartItems.length > 0) {
                loading.classList.add('d-none');
                container.innerHTML = `
                    <div class="alert alert-warning rounded-4 text-center mt-4">
                        <div class="fs-2 mb-2">โ๏ธ</div>
                        <h6 class="fw-bold">ุจูุงูุง ุทูุจุงุช ูุฏููุฉ</h6>
                        <p class="small">ููุงู ููุชุฌุงุช ูู ุณูุชู ูู ุชุนุฏ ููุฌูุฏุฉ ูู ุงููุชุฌุฑ (ุฑุจูุง ุจุณุจุจ ุชุญุฏูุซ ุงููุธุงู).</p>
                        <button onclick="clearCart()" class="btn btn-danger rounded-pill px-4 mt-2">ุชูุฑูุบ ุงูุณูุฉ ูุงูุจุฏุก ูู ุฌุฏูุฏ</button>
                    </div>
                `;
                return;
            }

            if (products.length === 0) {
                emptyMsg.classList.remove('d-none');
                summary.classList.add('d-none');
                return;
            }

            emptyMsg.classList.add('d-none');
            summary.classList.remove('d-none');

            let html = '';
            let subtotal = 0;

            products.forEach((item, index) => {
                subtotal += item.price;
                html += `
                <div class="card border-0 shadow-sm rounded-4 mb-3 overflow-hidden">
                    <div class="row g-0">
                        <div class="col-4 col-md-2">
                            <img src="${item.image_url}" class="img-fluid h-100 object-fit-cover" alt="${item.title}">
                        </div>
                        <div class="col-8 col-md-10">
                            <div class="card-body d-flex flex-column h-100">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="fw-bold mb-1">${item.title}</h6>
                                        <p class="small text-primary fw-bold mb-2">${item.price.toLocaleString()} ุฏ.ุน</p>
                                    </div>
                                    <button onclick="removeFromCart(${index})" class="btn btn-sm btn-outline-danger border-0">
                                        <span class="fs-5">๐๏ธ</span>
                                    </button>
                                </div>
                                <div class="bg-light p-2 rounded-3 small text-secondary mt-auto">
                                    <span class="fw-bold text-dark">ุงูููุงุญุธุงุช:</span> ${item.note}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            });

            container.innerHTML = html + `
                <div class="text-center mt-3">
                    <button onclick="clearCart()" class="btn btn-sm btn-link text-danger text-decoration-none">ุชูุฑูุบ ุงูุณูุฉ ุจุงููุงูู</button>
                </div>
            `;

            document.getElementById('subtotal').innerText = subtotal.toLocaleString() + " ุฏ.ุน";
            document.getElementById('total').innerText = (subtotal + 5000).toLocaleString() + " ุฏ.ุน";

        } catch (error) {
            loading.classList.add('d-none');
            container.innerHTML = `
                <div class="alert alert-danger rounded-4 text-center mt-4">
                    <h6 class="fw-bold">ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุฌููุฒ ุงูุณูุฉ</h6>
                    <p class="small mb-3">${error.message}</p>
                    <button onclick="location.reload()" class="btn btn-sm btn-primary rounded-pill px-4">ุฅุนุงุฏุฉ ุงููุญุงููุฉ</button>
                    <button onclick="clearCart()" class="btn btn-sm btn-outline-danger rounded-pill px-4 ms-2">ุชุตููุฑ ุงูุณูุฉ</button>
                </div>
            `;
            console.error('Error fetching cart details:', error);
        }
    }

    function removeFromCart(index) {
        let cart = JSON.parse(localStorage.getItem('cart') || '[]');
        cart.splice(index, 1);
        localStorage.setItem('cart', JSON.stringify(cart));
        location.reload();
    }

    function clearCart() {
        if (confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุชูุฑูุบ ุงูุณูุฉุ')) {
            localStorage.removeItem('cart');
            location.reload();
        }
    }
</script>
{% endblock %}